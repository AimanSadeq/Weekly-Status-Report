<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
  <meta name="description" content="Calendar view for VIFM Activity Tracker. View and manage employee activities by date across all departments.">
  <link rel="canonical" id="canonical-url" href="/calendar.html">
  <script>document.getElementById('canonical-url').href = window.location.origin + '/calendar.html';</script>
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-192x192.png">
  <meta property="og:title" content="VIFM Activity Calendar">
  <meta property="og:description" content="Calendar view for employee activity tracking and reporting.">
  <meta property="og:image" content="/vifm-logo.png">
  <title>VIFM Activity Tracker - Calendar View</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Open Sans', 'Arial', 'sans-serif'] },
          colors: {
            indigo: { 50:'#f0f5fb',100:'#dce6f4',200:'#b3cce8',300:'#84aed9',400:'#5391D5',500:'#4480c2',600:'#356daa',700:'#1e3f6e',800:'#121140',900:'#010131' }
          }
        }
      }
    }
  </script>
  <style>
    body { margin:0; font-family:'Open Sans',Arial,sans-serif; background:#f9fafb; }
    .cal-day { min-height: 100px; border: 1px solid #e5e7eb; transition: background 0.15s; cursor: pointer; }
    .cal-day:hover { background: #f0f5fb; }
    .cal-day.today { background: #dce6f4; border-color: #5391D5; }
    .cal-day.other-month { background: #f9fafb; color: #9ca3af; }
    .cal-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .cal-dot.draft { background: #9ca3af; }
    .cal-dot.submitted { background: #3b82f6; }
    .cal-dot.approved { background: #10b981; }
    .cal-dot.reviewed { background: #10b981; }
    .cal-dot.needs_revision { background: #f59e0b; }
    .detail-panel { display: none; }
    .detail-panel.active { display: block; }
  </style>
</head>
<body>
  <header class="bg-[#FEFFF9] text-indigo-900 shadow-lg border-b-4 border-indigo-400">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold flex items-center gap-2">
          <img src="/vifm-logo.png" alt="VIFM" width="1080" height="1080" class="h-8 w-auto"> Calendar View
        </h1>
        <p class="text-indigo-500 text-sm">Visual activity calendar</p>
      </div>
      <div class="flex gap-3">
        <a href="/" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Back to Dashboard</a>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Navigation -->
    <div class="flex items-center justify-between mb-6">
      <button id="prev-month" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold">&larr; Previous</button>
      <h2 id="month-title" class="text-2xl font-bold text-gray-900"></h2>
      <button id="next-month" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold">Next &rarr;</button>
    </div>

    <!-- Calendar Grid -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
      <!-- Day headers -->
      <div class="grid grid-cols-7 bg-indigo-800 text-white text-center text-sm font-semibold">
        <div class="py-3">Sun</div>
        <div class="py-3">Mon</div>
        <div class="py-3">Tue</div>
        <div class="py-3">Wed</div>
        <div class="py-3">Thu</div>
        <div class="py-3">Fri</div>
        <div class="py-3">Sat</div>
      </div>
      <!-- Calendar body -->
      <div id="calendar-body" class="grid grid-cols-7"></div>
    </div>

    <!-- Activity Detail Panel -->
    <div id="detail-panel" class="detail-panel mt-6 bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 id="detail-date" class="text-lg font-bold text-gray-900"></h3>
        <button id="close-detail" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
      </div>
      <div id="detail-activities" class="space-y-2"></div>
      <div class="mt-4">
        <a id="add-activity-link" href="/" class="inline-block px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-medium">+ Add Activity for This Date</a>
      </div>
    </div>
  </main>

  <script src="/auth-helpers.js"></script>
  <script>
    const currentUser = JSON.parse(localStorage.getItem('vif-user') || 'null');
    if (!currentUser || !localStorage.getItem('vif-token')) {
      window.location.href = '/';
    }

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let calendarData = {};

    async function loadCalendar() {
      try {
        const response = await authFetch(`/api/activities/calendar?month=${currentMonth + 1}&year=${currentYear}`);
        const data = await response.json();
        if (data.success) {
          calendarData = data.calendar || {};
        }
      } catch (error) {
        console.error('Failed to load calendar:', error);
        calendarData = {};
      }
      renderCalendar();
    }

    function renderCalendar() {
      const body = document.getElementById('calendar-body');
      const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      document.getElementById('month-title').textContent = `${months[currentMonth]} ${currentYear}`;

      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];

      let html = '';

      // Previous month days
      for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        html += `<div class="cal-day other-month p-2"><span class="text-xs">${day}</span></div>`;
      }

      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const isToday = dateStr === todayStr;
        const activities = calendarData[dateStr] || [];
        const dotHtml = activities.slice(0, 5).map(a =>
          `<span class="cal-dot ${a.status || 'draft'}" title="${escapeHtml(a.activityType || '')}"></span>`
        ).join(' ');
        const countText = activities.length > 5 ? `<span class="text-xs text-gray-500">+${activities.length - 5} more</span>` : '';

        html += `
          <div class="cal-day ${isToday ? 'today' : ''} p-2" data-date="${dateStr}" onclick="showDetail('${dateStr}')">
            <div class="flex justify-between items-start">
              <span class="text-sm font-semibold ${isToday ? 'text-indigo-700' : ''}">${day}</span>
              ${activities.length > 0 ? `<span class="text-xs bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded-full font-bold">${activities.length}</span>` : ''}
            </div>
            <div class="mt-1 flex flex-wrap gap-1">${dotHtml}${countText}</div>
            ${activities.slice(0, 2).map(a => `<div class="text-xs text-gray-600 truncate mt-0.5">${escapeHtml(a.activityType || '')}</div>`).join('')}
          </div>
        `;
      }

      // Next month days
      const totalCells = firstDay + daysInMonth;
      const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remaining; i++) {
        html += `<div class="cal-day other-month p-2"><span class="text-xs">${i}</span></div>`;
      }

      body.innerHTML = html;
    }

    function showDetail(dateStr) {
      const panel = document.getElementById('detail-panel');
      const activities = calendarData[dateStr] || [];
      const dateObj = new Date(dateStr + 'T00:00:00');
      document.getElementById('detail-date').textContent = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      const container = document.getElementById('detail-activities');
      if (activities.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">No activities for this date.</p>';
      } else {
        container.innerHTML = activities.map(a => `
          <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
            <div class="flex justify-between items-center">
              <div>
                <span class="font-semibold text-gray-900">${escapeHtml(a.activityType || '')}</span>
                <span class="text-gray-500 text-sm ml-2">${escapeHtml(a.department || '')}</span>
              </div>
              <div class="flex items-center gap-2">
                ${a.units ? `<span class="text-blue-700 font-semibold text-sm">${a.units} units</span>` : ''}
                <span class="cal-dot ${a.status || 'draft'}"></span>
                <span class="text-xs text-gray-500 capitalize">${a.status || 'draft'}</span>
              </div>
            </div>
            ${a.name ? `<div class="text-xs text-gray-500 mt-1">${escapeHtml(a.name)}</div>` : ''}
          </div>
        `).join('');
      }

      // Update "add activity" link
      document.getElementById('add-activity-link').href = `/?date=${dateStr}`;

      panel.classList.add('active');
      panel.scrollIntoView({ behavior: 'smooth' });
    }

    document.getElementById('close-detail').addEventListener('click', () => {
      document.getElementById('detail-panel').classList.remove('active');
    });

    document.getElementById('prev-month').addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      loadCalendar();
    });

    document.getElementById('next-month').addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      loadCalendar();
    });

    loadCalendar();
  </script>
</body>
</html>
